{% extends "base.html" %}

{% block title %}Feed - Discussion Den{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
<!-- Welcome Header -->
<div class="mb-4">
    <h1 class="h2 mb-2">Welcome to Discussion Den</h1>
    <p class="text-muted-custom">Share ideas, connect with others, and join the conversation.</p>
</div>

<!-- Create Post Box -->
{% if current_user.is_authenticated %}
<div class="card mb-4" id="create-post-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">‚úèÔ∏è Create a Post</h5>
        <small class="text-muted-custom">
            Posting as: 
            {% if active_identity.is_persona %}
                <span class="persona-badge">Persona</span> <strong>{{ active_identity.label }}</strong>
            {% else %}
                <span class="user-badge">User</span> <strong>{{ active_identity.label }}</strong>
            {% endif %}
        </small>
    </div>
    <div class="card-body p-4">
        <form id="quick-post-form" method="POST" action="{{ url_for('post.create_post_post') }}">
            {{ post_form.hidden_tag() }}
            
            <div class="mb-3">
                <label class="form-label">Community</label>
                <select name="community_id" class="form-select" required>
                    {% for community in communities %}
                    <option value="{{ community.id }}" {% if community.id == 1 %}selected{% endif %}>
                        r/{{ community.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-3">
                {{ post_form.title.label(class="form-label") }}
                {{ post_form.title(class="form-control", placeholder="What's on your mind?") }}
                {% if post_form.title.errors %}
                    <div class="text-danger small mt-2">
                        {% for error in post_form.title.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                {{ post_form.body.label(class="form-label") }}
                {{ post_form.body(class="form-control", rows="4", placeholder="Share your thoughts, ask a question, or start a discussion...") }}
                {% if post_form.body.errors %}
                    <div class="text-danger small mt-2">
                        {% for error in post_form.body.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                {{ post_form.image_url.label(class="form-label") }}
                {{ post_form.image_url(class="form-control", placeholder="https://example.com/image.jpg (optional)") }}
                {% if post_form.image_url.errors %}
                    <div class="text-danger small mt-2">
                        {% for error in post_form.image_url.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
                <div class="form-text text-muted-custom">Add an image to make your post more engaging (optional)</div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Publish Post</button>
                <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear</button>
                <button type="button" class="btn btn-outline-secondary" onclick="toggleCreatePost()">
                    <span id="toggle-text">Minimize</span>
                </button>
            </div>
        </form>
    </div>
</div>
{% else %}
<!-- Login Prompt for Non-authenticated Users -->
<div class="card mb-4">
    <div class="card-body text-center py-4">
        <h5 class="mb-3">Join the Conversation</h5>
        <p class="text-muted-custom mb-3">Sign up or log in to create posts and engage with the community.</p>
        <div>
            <a href="{{ url_for('auth.register') }}" class="btn btn-primary me-2">Sign Up</a>
            <a href="{{ url_for('auth.login') }}" class="btn btn-secondary">Log In</a>
        </div>
    </div>
</div>
{% endif %}

<!-- Future Feature Toggle (UI Only) -->
{% if current_user.is_authenticated %}
<div class="card mb-4">
    <div class="card-body py-3">
        <div class="form-check form-switch">
            <input class="form-check-input future-feature" type="checkbox" id="mixFeedToggle" disabled>
            <label class="form-check-label text-muted-custom" for="mixFeedToggle">
                Mix persona feed with main feed <span class="badge bg-secondary ms-2">Coming Soon</span>
            </label>
        </div>
    </div>
</div>
{% endif %}

<!-- Feed Container -->
<div id="feed-container">
    <!-- Posts are now loaded server-side -->
    {% if posts and posts|length > 0 %}
        {% for post in posts %}
        <div class="post-card" data-post-id="{{ post.id }}">
            <div class="post-header">
                {% if post.author_persona_id %}
                    <span class="persona-badge">Persona</span>
                {% else %}
                    <span class="user-badge">User</span>
                {% endif %}
                <span class="post-author">{{ post.author_name }}</span>
                <span class="text-muted-custom">‚Ä¢</span>
                <span class="post-meta">{{ post.created_at|timeago }}</span>
                {% if post.community %}
                <span class="text-muted-custom">‚Ä¢</span>
                <span class="post-meta">
                    <a href="{{ url_for('community.community_page', community_name=post.community.name) }}" 
                       style="color: var(--accent-primary); text-decoration: none;">
                        r/{{ post.community.name }}
                    </a>
                </span>
                {% endif %}
            </div>
            <h3 class="post-title">
                <a href="{{ url_for('post.post_detail', post_id=post.id) }}" style="color: inherit; text-decoration: none;">
                    {{ post.title }}
                </a>
            </h3>
            {% if post.body %}
            <div class="post-body">{{ post.body }}</div>
            {% endif %}
            {% if post.image_url %}
            <img src="{{ post.image_url }}" alt="Post image" class="post-image">
            {% endif %}
            <div class="action-buttons">
                <button class="btn-action vote-btn {% if post.user_vote == 1 %}voted-up{% endif %}" 
                        data-post-id="{{ post.id }}" data-vote="1">
                    ‚ñ≤ {{ post.upvotes or 0 }}
                </button>
                <button class="btn-action vote-btn {% if post.user_vote == -1 %}voted-down{% endif %}" 
                        data-post-id="{{ post.id }}" data-vote="-1">
                    ‚ñº {{ post.downvotes or 0 }}
                </button>
                <button class="btn-action save-btn {% if post.is_saved %}saved{% endif %}" 
                        data-post-id="{{ post.id }}">
                    {% if post.is_saved %}‚òÖ Saved{% else %}‚òÜ Save{% endif %}
                </button>
                <a href="{{ url_for('post.post_detail', post_id=post.id) }}" class="btn-action">
                    üí¨ {{ post.comment_count or 0 }} Comments
                </a>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <div style="font-size: 4rem; color: var(--text-muted); margin-bottom: 1rem;">üí¨</div>
                    <h3 class="h4 mb-3">No posts yet</h3>
                    <p class="text-muted-custom mb-4">Be the first to start a conversation and share your thoughts with the community.</p>
                </div>
                {% if current_user.is_authenticated %}
                <p class="text-muted-custom">Use the create post form above to get started!</p>
                {% else %}
                <div>
                    <a href="{{ url_for('auth.register') }}" class="btn btn-primary me-2">Join Discussion Den</a>
                    <a href="{{ url_for('auth.login') }}" class="btn btn-secondary">Login</a>
                </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// Disable infinite scroll since posts are loaded server-side
let infiniteScrollEnabled = false;

// Create Post Form Functions
function clearForm() {
    const form = document.getElementById('quick-post-form');
    if (form) {
        form.reset();
        // Reset community dropdown to default (campus)
        const communitySelect = form.querySelector('select[name="community_id"]');
        if (communitySelect) {
            communitySelect.selectedIndex = 0;
        }
    }
}

function toggleCreatePost() {
    const card = document.getElementById('create-post-card');
    const cardBody = card.querySelector('.card-body');
    const toggleText = document.getElementById('toggle-text');
    
    if (cardBody.style.display === 'none') {
        cardBody.style.display = 'block';
        toggleText.textContent = 'Minimize';
    } else {
        cardBody.style.display = 'none';
        toggleText.textContent = 'Expand';
    }
}

// Handle form submission with AJAX for better UX
document.addEventListener('DOMContentLoaded', function() {
    // Setup vote and save buttons for existing posts
    setupVoteButtons();
    setupSaveButtons();
    
    // Setup create post form
    const quickPostForm = document.getElementById('quick-post-form');
    if (quickPostForm) {
        quickPostForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(quickPostForm);
            const submitBtn = quickPostForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Publishing...';
            
            fetch(quickPostForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Clear form and show success message
                    clearForm();
                    showSuccessMessage(data.message || 'Post created successfully!');
                    
                    // Reload page to show the new post
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    // Handle validation errors
                    if (data.errors) {
                        let errorMessage = 'Please fix the following errors:\n';
                        for (const field in data.errors) {
                            data.errors[field].forEach(error => {
                                errorMessage += '‚Ä¢ ' + error + '\n';
                            });
                        }
                        alert(errorMessage);
                    } else {
                        alert(data.message || 'There was an error creating your post. Please try again.');
                    }
                }
            })
            .catch(error => {
                console.error('Error creating post:', error);
                alert('There was an error creating your post. Please try again.');
            })
            .finally(() => {
                // Restore button state
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        });
    }
});

function showSuccessMessage(message) {
    // Create a temporary success alert
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert after the create post card
    const createPostCard = document.getElementById('create-post-card');
    createPostCard.parentNode.insertBefore(alert, createPostCard.nextSibling);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

function getCSRFToken() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
        return metaTag.getAttribute('content');
    }
    
    const csrfInput = document.querySelector('input[name="csrf_token"]');
    if (csrfInput) {
        return csrfInput.value;
    }
    
    return '';
}

// Vote and Save button functions
function setupVoteButtons() {
    const voteButtons = document.querySelectorAll('.vote-btn');
    voteButtons.forEach(btn => {
        btn.addEventListener('click', handleVote);
    });
}

function setupSaveButtons() {
    const saveButtons = document.querySelectorAll('.save-btn');
    saveButtons.forEach(btn => {
        btn.addEventListener('click', handleSave);
    });
}

function handleVote(e) {
    e.preventDefault();
    const postId = this.getAttribute('data-post-id');
    const voteValue = parseInt(this.getAttribute('data-vote'));
    
    fetch(`/api/post/${postId}/vote`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ vote: voteValue })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateVoteUI(postId, data.vote, data.upvotes, data.downvotes);
        } else {
            alert('Failed to vote: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error voting:', error);
        alert('Error voting. Please try again.');
    });
}

function handleSave(e) {
    e.preventDefault();
    const postId = this.getAttribute('data-post-id');
    const isCurrentlySaved = this.classList.contains('saved');
    
    fetch(`/api/post/${postId}/save`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ save: !isCurrentlySaved })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSaveUI(postId, data.is_saved);
        } else {
            alert('Failed to save: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error saving:', error);
        alert('Error saving. Please try again.');
    });
}

function updateVoteUI(postId, userVote, upvotes, downvotes) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;
    
    const upBtn = postCard.querySelector(`.vote-btn[data-vote="1"]`);
    const downBtn = postCard.querySelector(`.vote-btn[data-vote="-1"]`);
    
    // Reset classes
    if (upBtn) {
        upBtn.classList.remove('voted-up', 'voted-down');
        upBtn.innerHTML = `‚ñ≤ ${upvotes || 0}`;
    }
    if (downBtn) {
        downBtn.classList.remove('voted-up', 'voted-down');
        downBtn.innerHTML = `‚ñº ${downvotes || 0}`;
    }
    
    // Apply new vote state
    if (userVote === 1 && upBtn) {
        upBtn.classList.add('voted-up');
    } else if (userVote === -1 && downBtn) {
        downBtn.classList.add('voted-down');
    }
}

function updateSaveUI(postId, isSaved) {
    const saveBtn = document.querySelector(`.save-btn[data-post-id="${postId}"]`);
    if (!saveBtn) return;
    
    if (isSaved) {
        saveBtn.classList.add('saved');
        saveBtn.innerHTML = '‚òÖ Saved';
    } else {
        saveBtn.classList.remove('saved');
        saveBtn.innerHTML = '‚òÜ Save';
    }
}
</script>
{% endblock %}
