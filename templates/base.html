<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}Discussion Den{% endblock %}</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- Authentication Modal Styles -->
    {% if not current_user.is_authenticated %}
    <style>
    /* Enhanced Authentication Modal */
    .modal-content-enhanced {
        background: var(--gradient-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-xl);
        box-shadow: var(--shadow-xl);
        overflow: hidden;
    }

    .modal-header-enhanced {
        background: var(--gradient-accent);
        border-bottom: none;
        padding: var(--space-6);
        color: white;
    }

    .modal-brand {
        display: flex;
        align-items: center;
        gap: var(--space-3);
    }

    .modal-brand .brand-icon {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: var(--border-radius);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-lg);
    }

    .modal-title {
        font-size: var(--text-xl);
        font-weight: var(--font-semibold);
        margin: 0;
    }

    .btn-close-enhanced {
        background: rgba(255, 255, 255, 0.1);
        border-radius: var(--border-radius-full);
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        color: white;
        opacity: 0.8;
        transition: var(--transition-base);
    }

    .btn-close-enhanced:hover {
        background: rgba(255, 255, 255, 0.2);
        opacity: 1;
        transform: var(--hover-lift);
    }

    .modal-body-enhanced {
        padding: var(--space-8);
    }

    .auth-switcher {
        display: flex;
        background: var(--bg-tertiary);
        border-radius: var(--border-radius-lg);
        padding: var(--space-1);
        margin-bottom: var(--space-8);
        border: 1px solid var(--border-color);
    }

    .auth-switch-btn {
        flex: 1;
        padding: var(--space-3) var(--space-4);
        background: transparent;
        border: none;
        border-radius: var(--border-radius);
        color: var(--text-secondary);
        font-weight: var(--font-medium);
        transition: var(--transition-base);
        cursor: pointer;
    }

    .auth-switch-btn.active {
        background: var(--gradient-accent);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .auth-switch-btn:hover:not(.active) {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .auth-form-container {
        animation: fadeIn 0.3s ease-out;
    }

    .input-group-enhanced {
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        transition: var(--transition-base);
    }

    .input-group-enhanced:focus-within {
        border-color: var(--accent-primary);
        box-shadow: var(--shadow-glow);
    }

    .input-group-enhanced .input-group-text {
        background: var(--bg-tertiary);
        border: none;
        color: var(--text-secondary);
        border-right: 1px solid var(--border-color);
    }

    .input-group-enhanced .form-control {
        border: none;
        background: var(--bg-secondary);
        color: var(--text-primary);
        padding: var(--space-3) var(--space-4);
    }

    .input-group-enhanced .form-control:focus {
        background: var(--bg-secondary);
        color: var(--text-primary);
        box-shadow: none;
    }

    .btn-enhanced {
        padding: var(--space-3) var(--space-6);
        font-weight: var(--font-semibold);
        border-radius: var(--border-radius-lg);
        transition: var(--transition-base);
        position: relative;
        overflow: hidden;
    }

    .btn-enhanced::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: var(--transition-base);
    }

    .btn-enhanced:hover::before {
        left: 100%;
    }

    .btn-enhanced:hover {
        transform: var(--hover-lift);
        box-shadow: var(--shadow-md);
    }

    .auth-divider {
        display: flex;
        align-items: center;
        margin: var(--space-6) 0;
        color: var(--text-muted);
        font-size: var(--text-sm);
    }

    .auth-divider::before,
    .auth-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: var(--border-color);
    }

    .auth-divider span {
        padding: 0 var(--space-4);
        background: var(--bg-card);
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    </style>
    {% endif %}
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Enhanced Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top" id="main-navbar">
        <div class="container-fluid px-4">
            <!-- Mobile Menu Toggle -->
            <button class="navbar-toggler-custom me-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- Brand -->
            <a class="navbar-brand" href="{{ url_for('feed.feed') }}">
                <div class="brand-container">
                    <div class="brand-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="brand-text">
                        <span class="brand-main">Discussion</span>
                        <span class="brand-accent">Den</span>
                    </div>
                </div>
            </a>
            
            <!-- Desktop Navigation -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link nav-link-enhanced" href="{{ url_for('feed.feed') }}">
                            <i class="fas fa-home me-2"></i>Feed
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-enhanced" href="{{ url_for('community.communities_list') }}">
                            <i class="fas fa-users me-2"></i>Communities
                        </a>
                    </li>
                    {% if current_user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link nav-link-enhanced nav-link-primary" href="{{ url_for('post.create_post') }}">
                            <i class="fas fa-plus me-2"></i>Create
                        </a>
                    </li>
                    {% endif %}
                </ul>
                
                <!-- Enhanced Search -->
                <form class="search-form me-4" method="GET" action="{{ url_for('search.search') }}">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input class="search-input" type="search" name="q" placeholder="Search discussions..." aria-label="Search">
                        <button class="search-btn" type="submit">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </form>
                
                <!-- User Menu -->
                <ul class="navbar-nav">
                    {% if current_user.is_authenticated %}
                        <!-- Persona Switcher -->
                        <li class="nav-item dropdown me-3">
                            <a class="nav-link dropdown-toggle persona-switcher" href="#" id="personaDropdown" role="button" data-bs-toggle="dropdown">
                                <div class="persona-display" id="active-identity-display">
                                    {% if session.get('active_persona_id') %}
                                        <div class="persona-badge-enhanced persona">
                                            <i class="fas fa-mask"></i>
                                            <span>Persona</span>
                                        </div>
                                    {% else %}
                                        <div class="persona-badge-enhanced user">
                                            <i class="fas fa-user"></i>
                                            <span>User</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-enhanced" id="persona-switcher-menu">
                                <li class="dropdown-header">Switch Identity</li>
                                <li>
                                    <a class="dropdown-item persona-switch-option" href="#" data-persona-id="null">
                                        <div class="persona-badge-enhanced user small">
                                            <i class="fas fa-user"></i>
                                            <span>User</span>
                                        </div>
                                        <span class="ms-2">{{ current_user.username }}</span>
                                    </a>
                                </li>
                                {% for persona in current_user.personas %}
                                <li>
                                    <a class="dropdown-item persona-switch-option" href="#" data-persona-id="{{ persona.id }}">
                                        <div class="persona-badge-enhanced persona small">
                                            <i class="fas fa-mask"></i>
                                            <span>Persona</span>
                                        </div>
                                        <span class="ms-2">{{ persona.name }}</span>
                                    </a>
                                </li>
                                {% endfor %}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('persona.create_persona') }}">
                                        <i class="fas fa-plus me-2"></i>New Persona
                                    </a>
                                </li>
                            </ul>
                        </li>
                        
                        <!-- User Menu -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle user-menu" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <div class="user-avatar">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <span class="user-name">{{ current_user.username }}</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-enhanced dropdown-menu-end">
                                <li class="dropdown-header">{{ current_user.username }}</li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('profile.user_profile', username=current_user.username) }}">
                                        <i class="fas fa-user me-2"></i>My Profile
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('profile.edit_profile') }}">
                                        <i class="fas fa-edit me-2"></i>Edit Profile
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">
                                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                                    </a>
                                </li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item me-2">
                            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#authModal" data-auth-mode="login">
                                <i class="fas fa-sign-in-alt me-1"></i>Login
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#authModal" data-auth-mode="register">
                                <i class="fas fa-user-plus me-1"></i>Join
                            </button>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Enhanced Offcanvas Sidebar -->
    <div class="offcanvas offcanvas-start offcanvas-enhanced" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarOffcanvasLabel">
        <div class="offcanvas-header">
            <div class="offcanvas-brand">
                <div class="brand-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <h5 class="offcanvas-title" id="sidebarOffcanvasLabel">Discussion Den</h5>
            </div>
            <button type="button" class="btn-close btn-close-enhanced" data-bs-dismiss="offcanvas" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="offcanvas-body">
            {% include 'includes/offcanvas_content.html' %}
        </div>
    </div>

    <!-- Flash Messages Enhanced -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-container">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-enhanced alert-dismissible fade show" role="alert">
                        <div class="alert-content">
                            <div class="alert-icon">
                                {% if category == 'success' %}
                                    <i class="fas fa-check-circle"></i>
                                {% elif category == 'danger' or category == 'error' %}
                                    <i class="fas fa-exclamation-circle"></i>
                                {% elif category == 'warning' %}
                                    <i class="fas fa-exclamation-triangle"></i>
                                {% else %}
                                    <i class="fas fa-info-circle"></i>
                                {% endif %}
                            </div>
                            <div class="alert-message">{{ message }}</div>
                        </div>
                        <button type="button" class="btn-close btn-close-enhanced" data-bs-dismiss="alert">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Layout Enhanced -->
    <main class="main-container">
        <div class="container-fluid">
            <div class="row g-4">
                <!-- Main Content Area -->
                <div class="col-lg-8">
                    <div class="main-content">
                        {% block content %}{% endblock %}
                    </div>
                </div>
                
                <!-- Right Sidebar -->
                <div class="col-lg-4 d-none d-lg-block">
                    <div class="sidebar-right">
                        {% include 'includes/right_panel.html' %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer-enhanced">
        <div class="container-fluid">
            <div class="footer-content">
                <div class="footer-brand">
                    <i class="fas fa-comments me-2"></i>
                    <span>Discussion Den</span>
                </div>
                <div class="footer-links">
                    <a href="#" class="footer-link">About</a>
                    <a href="#" class="footer-link">Privacy</a>
                    <a href="#" class="footer-link">Terms</a>
                    <a href="#" class="footer-link">Help</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Authentication Modal -->
    {% if not current_user.is_authenticated %}
    <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-content-enhanced">
                <div class="modal-header modal-header-enhanced">
                    <div class="modal-brand">
                        <div class="brand-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h5 class="modal-title" id="authModalLabel">Welcome to Discussion Den</h5>
                    </div>
                    <button type="button" class="btn-close btn-close-enhanced" data-bs-dismiss="modal" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body modal-body-enhanced">
                    <!-- Auth Mode Switcher -->
                    <div class="auth-switcher">
                        <button class="auth-switch-btn active" data-auth-mode="login">
                            <i class="fas fa-sign-in-alt me-2"></i>Login
                        </button>
                        <button class="auth-switch-btn" data-auth-mode="register">
                            <i class="fas fa-user-plus me-2"></i>Sign Up
                        </button>
                    </div>

                    <!-- Login Form -->
                    <div id="login-form-container" class="auth-form-container">
                        <form id="modal-login-form" method="POST" action="{{ url_for('auth.login_post') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="mb-4">
                                <label for="login-username" class="form-label">Username</label>
                                <div class="input-group input-group-enhanced">
                                    <span class="input-group-text">
                                        <i class="fas fa-user"></i>
                                    </span>
                                    <input type="text" class="form-control" id="login-username" name="username" required>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="login-password" class="form-label">Password</label>
                                <div class="input-group input-group-enhanced">
                                    <span class="input-group-text">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                    <input type="password" class="form-control" id="login-password" name="password" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 btn-enhanced">
                                <i class="fas fa-sign-in-alt me-2"></i>Login
                            </button>
                        </form>
                        
                        <!-- Google OAuth (if available) -->
                        <div class="auth-divider">
                            <span>or</span>
                        </div>
                        <a href="{{ url_for('auth.google_login') }}" class="btn btn-outline-secondary w-100 btn-enhanced">
                            <i class="fab fa-google me-2"></i>Continue with Google
                        </a>
                    </div>

                    <!-- Register Form -->
                    <div id="register-form-container" class="auth-form-container" style="display: none;">
                        <form id="modal-register-form" method="POST" action="{{ url_for('auth.register_post') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="mb-3">
                                <label for="register-username" class="form-label">Username</label>
                                <div class="input-group input-group-enhanced">
                                    <span class="input-group-text">
                                        <i class="fas fa-user"></i>
                                    </span>
                                    <input type="text" class="form-control" id="register-username" name="username" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="register-email" class="form-label">Email</label>
                                <div class="input-group input-group-enhanced">
                                    <span class="input-group-text">
                                        <i class="fas fa-envelope"></i>
                                    </span>
                                    <input type="email" class="form-control" id="register-email" name="email" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="register-password" class="form-label">Password</label>
                                <div class="input-group input-group-enhanced">
                                    <span class="input-group-text">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                    <input type="password" class="form-control" id="register-password" name="password" required>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="register-confirm-password" class="form-label">Confirm Password</label>
                                <div class="input-group input-group-enhanced">
                                    <span class="input-group-text">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                    <input type="password" class="form-control" id="register-confirm-password" name="confirm_password" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 btn-enhanced">
                                <i class="fas fa-user-plus me-2"></i>Create Account
                            </button>
                        </form>
                        
                        <!-- Google OAuth (if available) -->
                        <div class="auth-divider">
                            <span>or</span>
                        </div>
                        <a href="{{ url_for('auth.google_login') }}" class="btn btn-outline-secondary w-100 btn-enhanced">
                            <i class="fab fa-google me-2"></i>Sign up with Google
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/persona.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    
    <!-- Authentication Modal Script -->
    {% if not current_user.is_authenticated %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize authentication modal
        initializeAuthModal();
        
        // Initialize auth-gated actions
        initializeAuthGating();
    });

    function initializeAuthModal() {
        const authModal = document.getElementById('authModal');
        const authSwitchBtns = document.querySelectorAll('.auth-switch-btn');
        const loginContainer = document.getElementById('login-form-container');
        const registerContainer = document.getElementById('register-form-container');
        const modalTitle = document.getElementById('authModalLabel');

        // Handle auth mode switching
        authSwitchBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const mode = this.getAttribute('data-auth-mode');
                switchAuthMode(mode);
            });
        });

        // Handle modal trigger with specific mode
        document.addEventListener('click', function(e) {
            const trigger = e.target.closest('[data-bs-target="#authModal"]');
            if (trigger) {
                const mode = trigger.getAttribute('data-auth-mode') || 'login';
                setTimeout(() => switchAuthMode(mode), 100);
            }
        });

        function switchAuthMode(mode) {
            // Update switcher buttons
            authSwitchBtns.forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-auth-mode') === mode);
            });

            // Update form visibility
            if (mode === 'login') {
                loginContainer.style.display = 'block';
                registerContainer.style.display = 'none';
                modalTitle.textContent = 'Welcome Back';
            } else {
                loginContainer.style.display = 'none';
                registerContainer.style.display = 'block';
                modalTitle.textContent = 'Join Discussion Den';
            }
        }

        // Handle form submissions
        const loginForm = document.getElementById('modal-login-form');
        const registerForm = document.getElementById('modal-register-form');

        if (loginForm) {
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitAuthForm(this, 'login');
            });
        }

        if (registerForm) {
            registerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitAuthForm(this, 'register');
            });
        }
    }

    function submitAuthForm(form, mode) {
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Please wait...';

        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.ok) {
                // Success - redirect to feed
                window.location.href = "{{ url_for('feed.feed') }}";
            } else {
                return response.text().then(text => {
                    throw new Error('Authentication failed');
                });
            }
        })
        .catch(error => {
            console.error('Auth error:', error);
            
            // Show error message
            if (window.DiscussionDenTheme) {
                window.DiscussionDenTheme.showToast(
                    'Authentication failed. Please check your credentials and try again.',
                    'danger'
                );
            } else {
                alert('Authentication failed. Please check your credentials and try again.');
            }
        })
        .finally(() => {
            // Restore button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    }

    function initializeAuthGating() {
        // Gate voting actions
        document.addEventListener('click', function(e) {
            const voteBtn = e.target.closest('.vote-btn');
            if (voteBtn) {
                e.preventDefault();
                showAuthPrompt('vote on posts');
                return false;
            }

            const saveBtn = e.target.closest('.save-btn');
            if (saveBtn) {
                e.preventDefault();
                showAuthPrompt('save posts');
                return false;
            }
        });

        // Gate form submissions
        const createPostForm = document.getElementById('quick-post-form');
        if (createPostForm) {
            createPostForm.addEventListener('submit', function(e) {
                e.preventDefault();
                showAuthPrompt('create posts');
            });
        }
    }

    function showAuthPrompt(action) {
        if (window.DiscussionDenTheme) {
            window.DiscussionDenTheme.showToast(
                `Please log in to ${action}`,
                'info',
                3000
            );
        }
        
        // Show auth modal after a brief delay
        setTimeout(() => {
            const authModal = new bootstrap.Modal(document.getElementById('authModal'));
            authModal.show();
        }, 500);
    }
    </script>
    {% endif %}
    
    {% block extra_scripts %}{% endblock %}
</body>
</html>
